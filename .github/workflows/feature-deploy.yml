name: Deploy Feature Branch

on:
  push:
    branches:
      - '**'
    branches-ignore:
      - main
      - develop

jobs:
  deploy:
    name: Deploy to Feature Path
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      - name: Deploy to Digital Ocean Spaces
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          DO_SPACES_BUCKET: ${{ secrets.DO_SPACES_BUCKET }}
          DO_SPACES_ENDPOINT: ${{ secrets.DO_SPACES_ENDPOINT }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
          GITHUB_ACTIONS: 'true'
        run: npm run deploy:v2

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const branch = context.ref.replace('refs/heads/', '');
            const sanitizedBranch = branch.replace(/[^a-zA-Z0-9-_/]/g, '-').toLowerCase();
            const baseUrl = 'https://benelliot-nice.sgp1.digitaloceanspaces.com/cxone-expert-enhancements';
            const embedUrl = `${baseUrl}/${sanitizedBranch}/css-editor-embed.js`;

            const comment = `## ðŸš€ Branch Deployment Successful

            **Branch:** \`${branch}\`
            **Deployment Path:** \`cxone-expert-enhancements/${sanitizedBranch}/\`

            ### Usage

            Add this script to test this branch:

            \`\`\`html
            <script src="${embedUrl}"></script>
            \`\`\`

            ### All Files

            - [css-editor-embed.js](${baseUrl}/${sanitizedBranch}/css-editor-embed.js)
            - [css-editor.js](${baseUrl}/${sanitizedBranch}/css-editor.js)
            - [css-editor.css](${baseUrl}/${sanitizedBranch}/css-editor.css)
            `;

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
